# 给硬件工程师的信息清单

> **发送时间**: 2026-02-07
> **项目**: ATMWater 智能水站系统
> **目标**: 硬件团队同步开发，支持APP上线

---

## 📦 需要提供给硬件团队的资料

### 1. 核心文档（2份）

| 文档 | 位置 | 说明 |
|------|------|------|
| **TCP协议规范** | `硬件对接文档_TCP协议规范v1.0.md` | 完整的通信协议说明（683行） |
| **快速启动指南** | `硬件工程师快速启动指南.md` | 5分钟快速上手（100行） |

### 2. 服务器连接信息

```
生产环境（Zeabur）:
  地址: hkg1.clusters.zeabur.com
  端口: 30235
  协议: TCP
  格式: JSON（每条消息以 \n 结尾）

测试环境（本地）:
  地址: localhost
  端口: 55036
```

### 3. 测试设备信息

```
设备ID: DEVICE001
密码: 123456
设备名称: 测试水站001
每升价格: 500 印尼盾
```

### 4. 测试用户信息

```
手机号: 081234567890
初始余额: 100000 印尼盾
虚拟RFID: VIRT_081234567890

实体卡:
  RFID卡号: RFID001
  绑定用户: 081234567890
  状态: Active
```

---

## 🔧 硬件团队需要实现的功能

### 优先级P0（必须实现）

| # | 功能 | 说明 | 预计工作量 |
|---|------|------|-----------|
| 1 | **TCP连接** | 连接到服务器并保持连接 | 1小时 |
| 2 | **设备认证（AU）** | 上电后发送认证指令 | 30分钟 |
| 3 | **心跳保活（HB）** | 每60秒发送心跳 | 30分钟 |
| 4 | **刷卡出水（SW）** | 读取RFID→发送SW指令→收到OK后出水 | 2小时 |
| 5 | **接收扫码指令（DW）** | 接收服务器下发的DW指令并出水 | 1小时 |

### 优先级P1（建议实现）

| # | 功能 | 说明 | 预计工作量 |
|---|------|------|-----------|
| 6 | **设备状态上报（DS）** | 每5分钟上报状态 | 30分钟 |
| 7 | **水质数据上报（WQ）** | 每10分钟上报TDS和水温 | 1小时 |
| 8 | **自动重连** | 断网后自动重连并重新认证 | 1小时 |
| 9 | **错误处理** | 余额不足、网络超时等错误提示 | 1小时 |

### 优先级P2（可选）

| # | 功能 | 说明 |
|---|------|------|
| 10 | 本地显示屏 | 显示余额、出水量、错误信息 |
| 11 | 语音提示 | "请刷卡"、"余额不足"等 |
| 12 | 二维码打印 | 生成设备二维码贴纸 |

---

## 📋 支持的TCP指令清单

| 指令 | 方向 | 功能 | JSON示例 |
|------|------|------|---------|
| **AU** | 设备→服务器 | 设备认证 | `{"Cmd":"AU","DId":"DEVICE001","Pwd":"123456"}` |
| **HB** | 设备→服务器 | 心跳保活 | `{"Cmd":"HB","DId":"DEVICE001"}` |
| **SW** | 设备→服务器 | 刷卡出水 | `{"Cmd":"SW","DId":"DEVICE001","RFID":"RFID001","Vol":"2.5","Price":"500"}` |
| **DW** | 服务器→设备 | 扫码出水 | `{"Cmd":"DW","Vol":5.0,"Type":"pure","TransId":456}` |
| **DS** | 设备→服务器 | 状态上报 | `{"Cmd":"DS","DId":"DEVICE001","Status":"Online"}` |
| **WQ** | 设备→服务器 | 水质上报 | `{"Cmd":"WQ","DId":"DEVICE001","TDS":50,"Temp":25.5}` |

---

## 🎯 关键业务流程

### 流程1: 刷卡出水

```
1. 用户刷RFID卡
2. 设备读取卡号: "RFID001"
3. 设备发送: {"Cmd":"SW","DId":"DEVICE001","RFID":"RFID001","Vol":"2.5","Price":"500"}
4. 服务器验证余额并扣款
5. 服务器响应: {"Cmd":"SW","Result":"OK","Balance":97500,"TransactionId":123}
6. 设备收到"Result":"OK"后开始出水
7. 出水完成，显示剩余余额
```

**重要**: 必须收到 `"Result":"OK"` 才能出水！

### 流程2: 扫码出水

```
1. 用户在APP扫描设备二维码（格式: ATMWATER:DEVICE001:500）
2. 用户在APP选择水类型和数量
3. APP发送请求到服务器
4. 服务器验证余额并扣款
5. 服务器通过TCP发送到设备: {"Cmd":"DW","Vol":5.0,"Type":"pure","TransId":456}
6. 设备收到DW指令后立即开始出水
7. 出水完成
```

---

## 🔍 测试验证步骤

### 步骤1: 连接测试

1. 上传代码到ESP32
2. 打开串口监视器
3. 确认看到 `"Result":"OK"` 认证成功
4. 访问 https://atmwater-backend.zeabur.app/test
5. 确认设备出现在"在线设备列表"

### 步骤2: 刷卡测试

1. 模拟刷卡，发送SW指令（RFID: RFID001）
2. 确认收到 `"Result":"OK"` 和余额
3. 检查交易记录是否生成

### 步骤3: 扫码测试

1. 等待服务器发送DW指令（需要APP配合）
2. 收到DW指令后开始出水
3. 确认出水量正确

---

## 🛠️ 开发工具推荐

### Arduino库依赖

```cpp
#include <WiFi.h>          // ESP32自带
#include <ArduinoJson.h>   // 需要安装: https://arduinojson.org/
```

安装方法：
1. Arduino IDE → 工具 → 管理库
2. 搜索 "ArduinoJson"
3. 安装最新版本（v6.x）

### TCP调试工具

- **Windows**: Hercules SETUP utility
- **Mac/Linux**: `telnet` 或 `nc`
- **在线**: https://www.tcpiputils.com/tcp-client

### 测试命令

```bash
# 连接服务器
telnet hkg1.clusters.zeabur.com 30235

# 发送认证
{"Cmd":"AU","DId":"DEVICE001","Pwd":"123456"}

# 发送心跳
{"Cmd":"HB","DId":"DEVICE001"}

# 模拟刷卡
{"Cmd":"SW","DId":"DEVICE001","RFID":"RFID001","Vol":"2.5","Price":"500"}
```

---

## 📞 技术支持

### 联系方式

| 角色 | 联系方式 | 负责内容 |
|------|---------|---------|
| **后端开发** | [您的邮箱/微信] | TCP协议、数据库、API |
| **前端开发** | [您的邮箱/微信] | APP功能、扫码流程 |
| **项目经理** | [您的邮箱/微信] | 进度协调、需求确认 |

### 问题反馈渠道

- **紧急问题**: 微信群 / 电话
- **技术问题**: GitHub Issues / 邮件
- **测试仪表板**: https://atmwater-backend.zeabur.app/test

---

## 📅 开发时间表

| 日期 | 硬件团队任务 | 后端团队任务 |
|------|-------------|-------------|
| **2月7日（周五）** | 收到文档，开始开发 | 修复后端API路由 |
| **2月8日（周六）** | 完成P0功能（认证+心跳+刷卡） | 完成充值+扫码功能 |
| **2月9日（周日）** | 完成P1功能（状态上报+自动重连） | 完成管理后台+测试 |
| **2月10日（周一）** | 联调测试 | 联调测试 |

---

## ✅ 交付物清单

硬件团队需要交付：

- [ ] ESP32固件代码（.ino文件）
- [ ] 设备连接测试视频（证明能连接服务器）
- [ ] 刷卡出水测试视频（证明能正常扣款出水）
- [ ] 设备二维码贴纸样品（格式: ATMWATER:DEVICE001:500）
- [ ] 设备安装说明文档

---

## 🎁 附件

1. **硬件对接文档_TCP协议规范v1.0.md** - 完整协议说明（683行）
2. **硬件工程师快速启动指南.md** - 快速上手（100行）
3. **Arduino示例代码** - 见快速启动指南
4. **测试仪表板链接** - https://atmwater-backend.zeabur.app/test

---

> 📝 **备注**: 如有任何疑问，请随时联系后端开发团队。我们会在1小时内响应。


