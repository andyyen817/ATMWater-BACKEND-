const Withdrawal = require('../models/Withdrawal');
const User = require('../models/User');
const Transaction = require('../models/Transaction');
const { logAction } = require('../utils/logger'); // P3-WEB-006

/**
 * @desc    [APP端] 用户发起提现申请
 * @route   POST /api/withdrawals/request
 */
exports.requestWithdrawal = async (req, res) => {
    try {
        const { amount, bankDetails } = req.body;
        const user = await User.findById(req.user.id);

        if (!user || user.balance < amount) {
            return res.status(400).json({ success: false, message: 'Insufficient balance' });
        }

        // 预计算 (印尼本地税费逻辑模拟)
        const taxRate = 0.05; // 假设 5% 税
        const taxAmount = Math.round(amount * taxRate);
        const serviceFee = 500000; // 假设提现手续费 Rp 5,000
        const finalAmount = amount - taxAmount - serviceFee;

        if (finalAmount <= 0) {
            return res.status(400).json({ success: false, message: 'Withdrawal amount too small after deductions' });
        }

        const withdrawal = await Withdrawal.create({
            userId: user._id,
            amount,
            taxAmount,
            serviceFee,
            finalAmount,
            bankDetails,
            status: 'Pending'
        });

        // 冻结用户余额
        user.balance -= amount;
        await user.save();

        res.status(201).json({
            success: true,
            message: 'Withdrawal request submitted',
            data: withdrawal
        });

    } catch (error) {
        console.error('Request Withdrawal Error:', error);
        res.status(500).json({ success: false, message: 'Server Error' });
    }
};

/**
 * @desc    [WEB端] 获取所有提现申请
 * @route   GET /api/withdrawals/admin/list
 */
exports.getWithdrawals = async (req, res) => {
    try {
        const { status } = req.query;
        const query = status ? { status } : {};

        const list = await Withdrawal.find(query)
            .populate('userId', 'name phoneNumber role')
            .sort({ createdAt: -1 });

        res.status(200).json({
            success: true,
            data: list
        });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Server Error' });
    }
};

/**
 * @desc    [WEB端] 审核通过提现并记录交易
 * @route   POST /api/withdrawals/admin/approve/:id
 */
exports.approveWithdrawal = async (req, res) => {
    try {
        const withdrawal = await Withdrawal.findById(req.params.id);
        if (!withdrawal || withdrawal.status !== 'Pending') {
            return res.status(400).json({ success: false, message: 'Invalid withdrawal request' });
        }

        withdrawal.status = 'Approved';
        withdrawal.processedAt = Date.now();
        withdrawal.processedBy = req.user.id;
        await withdrawal.save();

        // [P3-WEB-006] 记录审计日志
        await logAction(req, 'Withdrawals', 'APPROVE_WITHDRAWAL', { withdrawalId: withdrawal._id, amount: withdrawal.finalAmount });

        // 记录交易流水 (财务审计)
        await Transaction.create({
            userId: withdrawal.userId,
            amount: withdrawal.amount,
            type: 'Withdrawal',
            status: 'Completed',
            description: `Withdrawal Approved: Gross Rp ${withdrawal.amount/100}, Tax Rp ${withdrawal.taxAmount/100}, Fee Rp ${withdrawal.serviceFee/100}`
        });

        res.status(200).json({
            success: true,
            message: 'Withdrawal approved successfully'
        });

    } catch (error) {
        res.status(500).json({ success: false, message: 'Server Error' });
    }
};

/**
 * @desc    [WEB端] 驳回提现申请
 * @route   POST /api/withdrawals/admin/reject/:id
 */
exports.rejectWithdrawal = async (req, res) => {
    try {
        const withdrawal = await Withdrawal.findById(req.params.id);
        if (!withdrawal || withdrawal.status !== 'Pending') {
            return res.status(400).json({ success: false, message: 'Invalid withdrawal request' });
        }

        const { reason } = req.body;
        withdrawal.status = 'Rejected';
        withdrawal.adminRemarks = reason || 'Rejected by Admin';
        withdrawal.processedAt = Date.now();
        withdrawal.processedBy = req.user.id;
        await withdrawal.save();

        // 退还金额给用户
        const user = await User.findById(withdrawal.userId);
        if (user) {
            user.balance += withdrawal.amount;
            await user.save();
        }

        // [P3-WEB-006] 记录审计日志
        await logAction(req, 'Withdrawals', 'REJECT_WITHDRAWAL', { withdrawalId: withdrawal._id, reason });

        res.status(200).json({
            success: true,
            message: 'Withdrawal rejected and funds returned'
        });

    } catch (error) {
        res.status(500).json({ success: false, message: 'Server Error' });
    }
};

/**
 * @desc    [APP/WEB] 获取提现历史
 * @route   GET /api/withdrawals/history
 */
exports.getWithdrawalHistory = async (req, res) => {
    try {
        const query = req.user.role === 'Super-Admin' || req.user.role === 'Finance' 
            ? {} 
            : { userId: req.user.id };

        const list = await Withdrawal.find(query).sort({ createdAt: -1 });
        res.status(200).json({ success: true, data: list });
    } catch (error) {
        res.status(500).json({ success: false, message: 'Server Error' });
    }
};

