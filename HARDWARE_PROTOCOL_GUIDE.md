# 硬件IOT通讯协议对接指南

**版本**: 2.0
**更新日期**: 2026-02-09
**状态**: ✅ 已完成硬件协议适配

---

## 📋 目录

1. [概述](#概述)
2. [连接配置](#连接配置)
3. [协议格式](#协议格式)
4. [指令详解](#指令详解)
5. [业务流程](#业务流程)
6. [错误处理](#错误处理)
7. [测试指南](#测试指南)
8. [常见问题](#常见问题)

---

## 概述

### 系统架构

```
硬件设备 <--TCP/JSON--> 后端服务器 <--HTTP/REST--> 前端管理后台
                                    <--MySQL--> 数据库
```

### 协议特点

- **传输协议**: TCP长连接
- **数据格式**: JSON
- **消息分隔**: `\n` (换行符)
- **字符编码**: UTF-8
- **心跳间隔**: 90秒
- **超时时间**: 180秒

---

## 连接配置

### 服务器地址

```
生产环境: hkg1.clusters.zeabur.com:30235
测试环境: localhost:55036
```

### 连接流程

1. 建立TCP连接
2. 发送AU认证指令
3. 等待服务器响应
4. 开始正常通信
5. 每90秒发送HB心跳

---

## 协议格式

### 消息格式

```json
{
  "Cmd": "指令代码",
  "DId": "设备ID",
  ...其他字段
}
```

### 字段命名规范

| 字段 | 说明 | 类型 | 示例 |
|------|------|------|------|
| Cmd | 指令代码 | String | "AU", "HB", "WR" |
| DId | 设备ID | String | "DEVICE001" |
| RFID | 卡号 | String | "99092104" |
| PWM | 脉冲数 | String | "1000" |
| Money | 金额 | String | "5000" |
| Tds | 纯水TDS | String | "15" |
| IDS | 进水TDS | String | "200" |
| Tmp | 温度 | String | "25" |
| TE | 时间戳 | String | "1707456789000" |
| RE | 记录ID | String | "REC001" |
| FT | 时间(秒) | String | "120" |

---

## 指令详解

### 1. AU - 设备认证

**用途**: 设备上线时进行身份认证

**设备请求**:
```json
{
  "Cmd": "AU",
  "DId": "DEVICE001",
  "Type": "WaterDispenser",
  "Pwd": "pudow",
  "Ver": "V1.0.0"
}
```

**服务器响应**:
```json
{
  "Cmd": "AU",
  "Time": 1707456789
}
```

**字段说明**:
- `DId`: 设备唯一标识
- `Type`: 设备类型
- `Pwd`: 认证密码（默认: pudow）
- `Ver`: 固件版本号
- `Time`: 服务器时间戳（Unix时间戳，秒）

---

### 2. HB - 心跳

**用途**: 保持连接活跃，上报设备状态

**设备请求（无告警）**:
```json
{
  "Cmd": "HB",
  "DId": "DEVICE001"
}
```

**设备请求（有告警）**:
```json
{
  "Cmd": "HB",
  "DId": "DEVICE001",
  "Errs": ["MakeWaterLong", "Press_Out_Err"]
}
```

**服务器响应**:
```json
{
  "Cmd": "HB"
}
```

**告警代码**:
- `MakeWaterLong`: 制水时间过长
- `Press_Out_Err`: 出水压力异常
- `TDS_High`: TDS值过高
- `Temp_High`: 温度过高
- `Leak_Detected`: 检测到漏水

**心跳间隔**: 90秒

---

### 3. WR - 用水数据记录上报 ⭐核心指令

**用途**: 用户刷卡出水后，上报用水记录

**业务流程**:
1. 用户刷卡
2. 设备读取RFID
3. 设备本地判断并出水
4. 出水完成后，设备上报记录（WR指令）
5. 服务器扣款并返回余额

**设备请求**:
```json
{
  "Cmd": "WR",
  "DId": "DEVICE001",
  "TE": "1707456789000",
  "RFID": "99092104",
  "PWM": "1000",
  "Money": "5000",
  "FT": "120",
  "Tds": "15",
  "IDS": "200",
  "RE": "REC001",
  "Tmp": "25"
}
```

**服务器响应**:
```json
{
  "Cmd": "WR",
  "RFID": "99092104",
  "RE": "REC001",
  "RT": "OK",
  "LeftL": "-1",
  "LeftM": "45000",
  "DayLmt": "-1"
}
```

**字段说明**:
- `TE`: 结束时间戳（毫秒）
- `RFID`: 用户卡号
- `PWM`: 用水脉冲数（需转换为升）
- `Money`: 本次消费金额（印尼盾）
- `FT`: 放水时间（秒）
- `Tds`: 纯水TDS值
- `IDS`: 进水TDS值
- `RE`: 记录ID（设备生成）
- `Tmp`: 水温（摄氏度）
- `RT`: 响应结果（OK/Fail）
- `LeftL`: 剩余升数（-1表示不限制）
- `LeftM`: 剩余金额（印尼盾）
- `DayLmt`: 每日限额（-1表示不限制）

**脉冲转换**:
```
升数 = PWM / pulsePerLiter
例如: PWM=1000, pulsePerLiter=1.0
     则: 升数 = 1000 / 1.0 = 1000升
```

---

### 4. Mk - 制水记录

**用途**: 上报设备制水过程数据

**设备请求**:
```json
{
  "Cmd": "Mk",
  "DId": "DEVICE001",
  "FT": "300",
  "PWM": "5000",
  "TDS": "12",
  "IDS": "180",
  "RC": "MK001"
}
```

**服务器响应**:
```json
{
  "Cmd": "Mk",
  "RT": "OK",
  "RC": "MK001"
}
```

**字段说明**:
- `FT`: 制水时间（秒）
- `PWM`: 制水脉冲数
- `TDS`: 纯水TDS
- `IDS`: 进水TDS
- `RC`: 记录编号

---

### 5. AddMoney - 充值命令

**用途**: 服务器主动向设备发送充值指令

**服务器请求**:
```json
{
  "Cmd": "AddMoney",
  "RFID": "99092104",
  "RE": "TOP001",
  "LeftL": "-1",
  "LeftM": "10000"
}
```

**设备响应**:
```json
{
  "Cmd": "AddMoney",
  "RT": "OK",
  "RC": "TOP001"
}
```

**字段说明**:
- `RFID`: 用户卡号
- `RE`: 记录ID
- `LeftL`: 剩余升数
- `LeftM`: 充值金额（正数充值，负数扣款）

---

### 6. OpenWater - 扫码放水

**用途**: 用户通过APP扫码后，服务器通知设备放水

**服务器请求**:
```json
{
  "Cmd": "OpenWater",
  "RFID": "w99092104",
  "Money": "3000",
  "PWM": "600",
  "Type": "RO",
  "RE": "QR001"
}
```

**设备响应**:
```json
{
  "Cmd": "OpenWater",
  "RT": "OK",
  "RC": "QR001"
}
```

**字段说明**:
- `RFID`: 虚拟账户（以'w'开头）
- `Money`: 金额
- `PWM`: 放水脉冲数
- `Type`: 水类型（RO/UF）
- `RE`: 记录ID

---

### 7. DS - 设备状态上报

**用途**: 上报设备运行状态

**设备请求**:
```json
{
  "Cmd": "DS",
  "DId": "DEVICE001",
  "Status": "Online",
  "ErrorCode": null
}
```

**服务器响应**:
```json
{
  "Cmd": "DS",
  "Result": "OK"
}
```

---

### 8. WQ - 水质数据上报

**用途**: 定期上报水质监测数据

**设备请求**:
```json
{
  "Cmd": "WQ",
  "DId": "DEVICE001",
  "TDS": 18,
  "Temp": 26.5
}
```

**服务器响应**:
```json
{
  "Cmd": "WQ",
  "Result": "OK"
}
```

---

## 业务流程

### 刷卡出水流程

```
1. 用户刷卡
   ↓
2. 设备读取RFID
   ↓
3. 设备本地判断（可选）
   ↓
4. 设备开始出水
   ↓
5. 出水完成
   ↓
6. 设备发送WR指令上报记录
   ↓
7. 服务器验证用户和余额
   ↓
8. 服务器扣款
   ↓
9. 服务器返回剩余余额
   ↓
10. 设备显示余额
```

### 扫码出水流程

```
1. 用户打开APP扫码
   ↓
2. APP发送请求到服务器
   ↓
3. 服务器验证用户和余额
   ↓
4. 服务器发送OpenWater指令到设备
   ↓
5. 设备收到指令后出水
   ↓
6. 设备返回确认
   ↓
7. 服务器扣款
   ↓
8. APP显示出水成功
```

---

## 错误处理

### 错误响应格式

```json
{
  "Cmd": "ER",
  "Msg": "错误描述"
}
```

### 常见错误

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| Device not found | 设备未注册 | 在管理后台添加设备 |
| Invalid password | 密码错误 | 检查设备密码配置 |
| Card not found | 卡号不存在 | 用户需要先注册 |
| Insufficient balance | 余额不足 | 用户需要充值 |
| Server error | 服务器异常 | 检查服务器日志 |

---

## 测试指南

### 运行测试脚本

```bash
# 进入后端目录
cd d:\airkopapp\JKT99ATM-main\ATMWater-BACKEND

# 运行测试
node test-hardware-protocol.js
```

### 测试用例

测试脚本包含以下测试用例:

1. ✅ AU - 设备认证
2. ✅ HB - 心跳（无告警）
3. ✅ HB - 心跳（带告警）
4. ✅ WR - 用水数据记录上报
5. ✅ Mk - 制水记录
6. ✅ AddMoney - 充值命令
7. ✅ OpenWater - 扫码放水
8. ✅ DS - 设备状态上报
9. ✅ WQ - 水质数据上报
10. ✅ SW - 刷卡出水（兼容旧系统）

### 手动测试

使用`telnet`或`nc`工具手动测试:

```bash
# 连接服务器
telnet localhost 55036

# 发送认证指令
{"Cmd":"AU","DId":"DEVICE001","Type":"WaterDispenser","Pwd":"pudow","Ver":"V1.0.0"}

# 发送心跳
{"Cmd":"HB","DId":"DEVICE001"}

# 发送用水记录
{"Cmd":"WR","DId":"DEVICE001","TE":"1707456789000","RFID":"VIRT_081234567890","PWM":"1000","Money":"5000","FT":"120","Tds":"15","IDS":"200","RE":"REC001","Tmp":"25"}
```

---

## 常见问题

### Q1: 设备认证失败怎么办？

**A**: 检查以下几点:
1. 设备ID是否在数据库中注册
2. 密码是否正确（默认: pudow）
3. 网络连接是否正常
4. 服务器是否正常运行

### Q2: 心跳超时怎么办？

**A**:
1. 确保心跳间隔为90秒
2. 检查网络稳定性
3. 查看服务器日志

### Q3: WR指令返回Fail怎么办？

**A**: 检查:
1. RFID卡号是否存在
2. 用户余额是否充足
3. 设备ID是否正确
4. 数据格式是否正确

### Q4: 如何调试协议问题？

**A**:
1. 查看服务器日志: `d:\airkopapp\JKT99ATM-main\ATMWater-BACKEND\logs`
2. 使用测试脚本验证
3. 使用Wireshark抓包分析
4. 检查数据库记录

### Q5: 脉冲数如何转换为升？

**A**:
```
升数 = PWM / pulsePerLiter

pulsePerLiter在数据库Unit表中配置
默认值为1.0，可根据实际硬件调整
```

---

## 数据库字段映射

### Units表新增字段

| 字段 | 类型 | 说明 |
|------|------|------|
| firmwareVersion | VARCHAR(50) | 固件版本号 |
| pulsePerLiter | DECIMAL(10,2) | 每升脉冲数 |
| errorCodes | TEXT | 告警代码（JSON数组） |

### Transactions表新增字段

| 字段 | 类型 | 说明 |
|------|------|------|
| pulseCount | INT | 脉冲数 |
| inputTds | INT | 进水TDS |
| outputTds | INT | 纯水TDS |
| waterTemp | DECIMAL(5,2) | 水温 |
| recordId | VARCHAR(50) | 硬件记录ID |
| dispensingTime | INT | 放水时间（秒） |

---

## 版本历史

### v2.0 (2026-02-09)
- ✅ 实现WR指令（用水数据记录上报）
- ✅ 修改AU指令（添加Ver字段）
- ✅ 修改HB指令（添加Errs数组）
- ✅ 实现Mk指令（制水记录）
- ✅ 实现AddMoney指令（充值命令）
- ✅ 实现OpenWater指令（扫码放水）
- ✅ 调整心跳超时为180秒
- ✅ 添加数据库字段支持
- ✅ 创建测试脚本

### v1.0 (2025-12-01)
- 初始版本
- 实现AU、HB、SW、DS、WQ指令

---

## 技术支持

如有问题，请联系:
- 技术支持邮箱: support@example.com
- 开发团队: dev@example.com

---

**文档更新**: 2026-02-09
**维护者**: IOT协议实现专家
